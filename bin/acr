#!/usr/bin/env bash

# b    = everything?
# fx   = xrandr
# fxd  = xrandr double
# fxd  = xrandr triple
# k    = keyboard layout
# ko   = keyboard layout old, via xmodmap
# keys = ssh keys
# tr   = trayerx

CMDS=("b" "fx" "fxd" "fxt" "k" "ko" "keys" "tr")
########################################
DF=$(dirname "$(readlink -f "$(which "$0")")")
TOOL="$1"

if [ "${TOOL}" = "" ]; then
    for item in "${CMDS[@]}"; do
        echo $item;
    done
    find $DF -maxdepth 1 -type f -name "__*" | while read f; do
        echo $(basename $f)
    done
    exit
fi
###################
if [ "${TOOL}" = "b" ]; then
   "${DF}/acr" fxt
   "${DF}/acr" xm
   "${DF}/acr" tr
   "${DF}/acr" keys
fi
###################
if [ "${TOOL}" = "fx" ]; then
    shift
    "${DF}/__my-fx" "$@"
    exit
fi
###################
if [ "${TOOL}" = "fxd" ]; then
    "${DF}/__my-fx" --single && "${DF}/my-fx" --double
    exit
fi
###################
if [ "${TOOL}" = "fxt" ]; then
    "${DF}/__my-fx" --single && "${DF}/my-fx" --triple
    exit
fi
###################
if [ "${TOOL}" = "k" ]; then
    setxkbmap -layout usde
    exit
fi
###################
if [ "${TOOL}" = "ko" ]; then
    xmodmap "${DF}/../.us-intl-german.xmodmap"
    exit
fi
###################
if [ "${TOOL}" = "keys" ]; then
    keylist="${HOME}/.config/art-core/ssh-keylist"
    if [ -f "$keylist" ]; then
        rsa_keys=$(cat $keylist | grep '^rsa:' | sed 's/^rsa://' )
        ed_keys=$(cat $keylist | grep '^ed:' | sed 's/^ed://' )
        for k in $rsa_keys; do
            fk="${HOME}/.ssh/${k}"
            echo $fk
            /usr/bin/ssh-add -l | grep "$fk" || /usr/bin/ssh-add "$fk"
        done
        for k in $ed_keys; do
            fk="${HOME}/.ssh/${k}"
            _comm=$(cat $fk | cut -d' ' -f 3-)
            echo $fk
            /usr/bin/ssh-add -l | grep "${_comm} (ED25519)$" || /usr/bin/ssh-add "$fk"
        done
    else
        fk="${HOME}/.ssh/id_rsa"
        echo $fk
        /usr/bin/ssh-add -l | grep "$fk" || /usr/bin/ssh-add "$fk"
    fi
    exit
fi
###################
if [ "${TOOL}" = "tr" ]; then
    shift
    "${DF}/trayerx" "$@"
    exit
fi

# without a match, try
# dotfiles/bin/run/$TOOL and then
# dotfiles/bin/$TOOL
if [ -f "${DF}/run/${TOOL}" ]; then
    shift
    "${DF}/run/${TOOL}" "$@"
    exit
fi
if [ -f "${DF}/${TOOL}" ]; then
    shift
    "${DF}/${TOOL}" "$@"
    exit
fi
