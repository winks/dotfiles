#!/usr/bin/env bash

DEBUG=0
if [ "$1" = "--debug" ]; then
  DEBUG=1
  shift
fi
mode="$1"

########################################
# some config
main_name="LVDS-1"
main_res="1366x768"
main_scale=""

second_name="VGA-1"
second_res="1920x1080"
second_scale=""
second_fb=""

third_name="VGA-1"
third_res="1024x768"
third_scale=""

# check for HiDPI panel (T460p)
_ck=$(xrandr | grep "eDP-1 connected")
if [ $? = 0 ]; then
    main_name="eDP-1"
    main_res="2560x1440"
    main_scale="--scale 1x1"
    second_name="HDMI-1"
    second_res="1920x1080"
    second_scale="--scale 1.333x1.333"
    second_fb="--panning 2560x1440+2560+0"
fi

# check for third screen connected
# @TODO

function bg_set() {
    if [ -f "${HOME}/.fehbg" ]; then
        ${HOME}/.fehbg 2>&1| grep -v 'libpng warning: iCCP: known incorrect'
    fi
}

function run() {
    if [ $DEBUG = 1 ]; then
        echo " $@"
        RET=0
    else
        RET=$("$@")
    fi
    return $RET
}

########################################
# notebook
########################################
echo "Main screen $main_name @ $main_res"
cmd="xrandr --output $main_name --mode $main_res $main_scale"
run $cmd

# on "Can't open display" use -d :0 for xrandr

########################################
# single screen
########################################
if [ "${mode}" = "--single" ]; then
    echo "Switching to single-display mode..."
    cmd="xrandr --output $second_name --off"
    run $cmd
    RET=$?
    bg_set
    exit $RET;
fi
# wtf?
#xrandr --output VGA1 --mode 2048x1152 --right-of LVDS1

########################################
# beamer
########################################
if [ "${mode}" = "--beamer" ]; then
    second_res='1024x768'
    echo "Second screen: $second_name @ $second_res (mirror)"
    cmd="xrandr --output $second_name --mode $second_res --same-as $main_name --rotate normal"
    run $cmd
    RET=$?
    bg_set
    exit $RET;
fi

########################################
# big 24"/27" or whatever
########################################
if [ "${mode}" = "--double" ]; then
    echo "Second screen: $second_name @ $second_res (right)"
    cmd="xrandr --output $second_name --mode $second_res --right-of $main_name --rotate normal $second_scale $second_fb --auto"
    run $cmd
    RET=$?
    bg_set
    exit $RET;
fi

########################################
# three screens
########################################
if [ "${mode}" = "--triple" ]; then
    echo "Second screen: $second_res (right)"
    cmd="xrandr --output $second_name --mode $second_res --right-of $main_name --rotate normal"
    run $cmd
    RET=$?
    cmd="xrandr --output $third_name --mode $third_res --right-of $second_name --rotate normal"
    run $cmd
    RET=$?
    bg_set
    exit $RET;
fi
